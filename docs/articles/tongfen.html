<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>General TongFen • tongfen</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/simplex/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="General TongFen">
<meta property="og:description" content="tongfen">
<meta property="og:image" content="https://mountainmath.github.io/tongfen/logo.png">
<meta property="og:image:alt" content="tongfen">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:creator" content="@vb_jens">
<meta name="twitter:site" content="https://mountainmath.github.io/tongfen/">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">tongfen</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.3.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/tongfen.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/polling_districts.html">Polling Districts</a>
    </li>
    <li>
      <a href="../articles/tongfen_ca.html">TongFen for Canadian census data</a>
    </li>
    <li>
      <a href="../articles/tongfen-ca-estimate.html">Estimating Canadian data on custom geographies</a>
    </li>
    <li>
      <a href="../articles/tongfen_us.html">TongFen for US census data</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mountainMath/tongfen/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="tongfen_files/header-attrs-2.7/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>General TongFen</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mountainMath/tongfen/blob/master/vignettes/tongfen.Rmd"><code>vignettes/tongfen.Rmd</code></a></small>
      <div class="hidden name"><code>tongfen.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mountainMath/tongfen">tongfen</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org">tidyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mountainMath/cancensus">cancensus</a></span><span class="op">)</span></code></pre></div>
<p>Data often comes on different yet congruent geographies. A prime example is census data, where census geographies change between census years, yet boundary changes happen in a way that one can create a “least common geography” by aggregating up some areas in each census until the resulting aggregated areas match across census years.</p>
<p>To see how this works we will start with census tract level geographies in Vancouver across four census years to understand population change. In this example we are utilizing the <a href="https://mountainmath.github.io/cancensus/index.html">{cancensus} package</a> to import the data for three separate census years.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">vsb_regions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>CSD<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"5915022"</span>,<span class="st">"5915803"</span><span class="op">)</span>,
                    CT<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"9330069.01"</span>,<span class="st">"9330069.02"</span>,<span class="st">"9330069.00"</span><span class="op">)</span><span class="op">)</span>

<span class="va">geo_identifiers</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">years</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">2001</span>,<span class="fl">2016</span>,<span class="fl">5</span><span class="op">)</span>
<span class="va">geo_identifiers</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"GeoUIDCA"</span>,<span class="fu"><a href="https://rdrr.io/r/base/substr.html">substr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">years</span><span class="op">)</span>,<span class="fl">3</span>,<span class="fl">4</span><span class="op">)</span><span class="op">)</span>
<span class="va">data</span> <span class="op">&lt;-</span> <span class="va">years</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">year</span><span class="op">)</span><span class="op">{</span>
  <span class="va">dataset</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"CA"</span>,<span class="fu"><a href="https://rdrr.io/r/base/substr.html">substr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span>,<span class="fl">3</span>,<span class="fl">4</span><span class="op">)</span><span class="op">)</span>
  <span class="va">uid_label</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"GeoUID"</span>,<span class="va">dataset</span><span class="op">)</span>
  <span class="fu"><a href="https://mountainmath.github.io/cancensus/index.html/reference/get_census.html">get_census</a></span><span class="op">(</span><span class="va">dataset</span>, regions<span class="op">=</span><span class="va">vsb_regions</span>, geo_format <span class="op">=</span> <span class="st">'sf'</span>, level<span class="op">=</span><span class="st">"CT"</span>, quiet<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/sf.html">st_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/name.html">as.name</a></span><span class="op">(</span><span class="va">uid_label</span><span class="op">)</span><span class="op">:=</span><span class="va">GeoUID</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Year<span class="op">=</span><span class="va">year</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="va">years</span><span class="op">)</span></code></pre></div>
<p>Plotting the cenus tracts for our four census years shows how census tracts changed over the years.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">data</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>fill<span class="op">=</span><span class="st">"steelblue"</span>,colour<span class="op">=</span><span class="st">"brown"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">coord_sf</a></span><span class="op">(</span>datum<span class="op">=</span><span class="cn">NA</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="st">"Year"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">"Vancouver census tracts"</span>,caption<span class="op">=</span><span class="st">"StatCan Census 2001-2016"</span><span class="op">)</span></code></pre></div>
<p><img src="tongfen_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
<p>For this example we will estimate the correspondence between these regions from the geographic data using the <code>estimate_tongfen_correspondence</code> function. Unfortunately this is not an exact science, for example over the years census regions get adjusted to better align with the road network. Other harmless boundary adjustemens can happen along water boundaries, or re-jigging boundaries in unpopulated areas.</p>
<p>We are going to impose a tolerance of 200m, where we are calling two census tract the same if they differ by no more than 200m. We are specifying that these calculations should be carried out in the Statistics Canada Lambert (EPSG:3347) refernce system with units metres.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">correspondence</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/estimate_tongfen_correspondence.html">estimate_tongfen_correspondence</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">geo_identifiers</span>,
                                                   tolerance<span class="op">=</span><span class="fl">200</span>, computation_crs<span class="op">=</span><span class="fl">3347</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">correspondence</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 x 7</span>
<span class="co">#&gt;   GeoUIDCA01 GeoUIDCA06 GeoUIDCA11 GeoUIDCA16 TongfenMethod TongfenID TongfenUID</span>
<span class="co">#&gt;   &lt;chr&gt;      &lt;chr&gt;      &lt;chr&gt;      &lt;chr&gt;      &lt;chr&gt;         &lt;chr&gt;     &lt;chr&gt;     </span>
<span class="co">#&gt; 1 9330040.01 9330040.01 9330040.01 9330040.01 estimate      9330040.… GeoUIDCA0…</span>
<span class="co">#&gt; 2 9330050.04 9330050.04 9330050.04 9330050.04 estimate      9330050.… GeoUIDCA0…</span>
<span class="co">#&gt; 3 9330054.02 9330054.02 9330054.02 9330054.02 estimate      9330054.… GeoUIDCA0…</span>
<span class="co">#&gt; 4 9330060.02 9330060.02 9330060.02 9330060.02 estimate      9330060.… GeoUIDCA0…</span>
<span class="co">#&gt; 5 9330001.01 9330001.01 9330001.01 9330001.01 estimate      9330001.… GeoUIDCA0…</span>
<span class="co">#&gt; 6 9330015.01 9330015.01 9330015.01 9330015.01 estimate      9330015.… GeoUIDCA0…</span></code></pre></div>
<p>Before we proceed it is useful to check the integrity of our correspondence. One quick way to understand mismatches is to aggregate up the geographies for each year to the common geography and compare their areas. The (logarithm of the) maximum ratio of areas for each region of the common geography gives some measure of mismatch, where taking the logarithm serves to make this measure symmetric.</p>
<p>The <code>check_tongfen_areas</code> function does exactly this, and we inspect the list of areas in the common geography with maximum log area ratios greater than 0.1. This corresponds to a difference in area of about 10% or more.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">tongfen_area_check</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/check_tongfen_areas.html">check_tongfen_areas</a></span><span class="op">(</span><span class="va">data</span>,<span class="va">correspondence</span><span class="op">)</span>

<span class="va">tongfen_area_check</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">max_log_ratio</span><span class="op">&gt;</span><span class="fl">0.1</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 2 x 7</span>
<span class="co">#&gt;   TongfenID  area_2001 area_2006 area_2011 area_2016 TongfenMethod max_log_ratio</span>
<span class="co">#&gt;   &lt;chr&gt;          [m^2]     [m^2]     [m^2]     [m^2] &lt;chr&gt;                 &lt;dbl&gt;</span>
<span class="co">#&gt; 1 9330005.00   1370041   1565155   1569750   1593819 estimate              0.151</span>
<span class="co">#&gt; 2 9330008.00   5509380   6970320   6943538   6943917 estimate              0.235</span></code></pre></div>
<p>We see that there are two such regions, and it appears that the mismatch is mostly due to the 2001 geography being different. It’s worthwhile to inspect the regions in question by aggregating up the data to the common geography based on 2001 and one of the other geographies and compare the result.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mismatched_tongfen_ids</span> <span class="op">&lt;-</span> <span class="va">tongfen_area_check</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">max_log_ratio</span><span class="op">&gt;</span><span class="fl">0.1</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">TongfenID</span><span class="op">)</span>
<span class="va">mismatch_correspondence</span> <span class="op">&lt;-</span> <span class="va">correspondence</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">TongfenID</span> <span class="op">%in%</span> <span class="va">mismatched_tongfen_ids</span><span class="op">)</span>


<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2001</span>,<span class="fl">2016</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">year</span><span class="op">)</span><span class="op">{</span>
    <span class="fu"><a href="../reference/tongfen_aggregate.html">tongfen_aggregate</a></span><span class="op">(</span><span class="va">data</span>,<span class="va">mismatch_correspondence</span>,base_geo <span class="op">=</span> <span class="va">year</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Year<span class="op">=</span><span class="va">year</span><span class="op">)</span>
  <span class="op">}</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>data<span class="op">=</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_combine.html">st_union</a></span><span class="op">(</span><span class="va">data</span><span class="op">[[</span><span class="fl">4</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>fill<span class="op">=</span><span class="st">"steelblue"</span>,colour<span class="op">=</span><span class="st">"brown"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">coord_sf</a></span><span class="op">(</span>datum<span class="op">=</span><span class="cn">NA</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="st">"Year"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">"Tongfen area mismatch check"</span>,caption<span class="op">=</span><span class="st">"StatCan Census 2001-2016"</span><span class="op">)</span></code></pre></div>
<p><img src="tongfen_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<p>It appears that the difference is explained by the 2001 geography having the hydro layer clipped out and better fit the north arm of the Fraser river. For completeness we will also visually inspect the common geographies based on all four input geographies.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">years</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">year</span><span class="op">)</span><span class="op">{</span>
    <span class="fu"><a href="../reference/tongfen_aggregate.html">tongfen_aggregate</a></span><span class="op">(</span><span class="va">data</span>,<span class="va">correspondence</span>,base_geo <span class="op">=</span> <span class="va">year</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Year<span class="op">=</span><span class="va">year</span><span class="op">)</span>
  <span class="op">}</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>fill<span class="op">=</span><span class="st">"steelblue"</span>,colour<span class="op">=</span><span class="st">"brown"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">coord_sf</a></span><span class="op">(</span>datum<span class="op">=</span><span class="cn">NA</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="st">"Year"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title<span class="op">=</span><span class="st">"Tongfen aggregates visual inspection"</span>,caption<span class="op">=</span><span class="st">"StatCan Census 2001-2016"</span><span class="op">)</span></code></pre></div>
<p><img src="tongfen_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
<div id="population-change" class="section level2">
<h2 class="hasAnchor">
<a href="#population-change" class="anchor"></a>Population change</h2>
<p>It’s time to go back to our original goal of mapping population change. For this we need to specify how to aggregate up the population data, which is by simply adding them up. The <code>meta_for_additive_variables</code> convenience function generates the appropriate metatdata that specifies how to deal with this data.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">meta</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/meta_for_additive_variables.html">meta_for_additive_variables</a></span><span class="op">(</span><span class="va">years</span>,<span class="st">"Population"</span><span class="op">)</span>
<span class="va">meta</span>
<span class="co">#&gt; # A tibble: 4 x 8</span>
<span class="co">#&gt;   variable   dataset label          type  aggregation rule    geo_dataset parent</span>
<span class="co">#&gt;   &lt;chr&gt;        &lt;dbl&gt; &lt;chr&gt;          &lt;chr&gt; &lt;chr&gt;       &lt;chr&gt;         &lt;dbl&gt; &lt;lgl&gt; </span>
<span class="co">#&gt; 1 Population    2001 Population_20… Manu… Additive    Additi…        2001 NA    </span>
<span class="co">#&gt; 2 Population    2006 Population_20… Manu… Additive    Additi…        2006 NA    </span>
<span class="co">#&gt; 3 Population    2011 Population_20… Manu… Additive    Additi…        2011 NA    </span>
<span class="co">#&gt; 4 Population    2016 Population_20… Manu… Additive    Additi…        2016 NA</span></code></pre></div>
<p>What’s left is to add up the population data. We choose 2001 as the base year as the clipped boundaries look better.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">breaks</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.15</span>,<span class="op">-</span><span class="fl">0.1</span>,<span class="op">-</span><span class="fl">0.075</span>,<span class="op">-</span><span class="fl">0.05</span>,<span class="op">-</span><span class="fl">0.025</span>,<span class="fl">0</span>,<span class="fl">0.025</span>,<span class="fl">0.05</span>,<span class="fl">0.1</span>,<span class="fl">0.2</span>,<span class="fl">0.3</span><span class="op">)</span>
<span class="va">labels</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"-15% to -10%"</span>,<span class="st">"-10% to -7.5%"</span>,<span class="st">"-7.5% to -5%"</span>,<span class="st">"-5% to -2.5%"</span>,<span class="st">"-2.5% to 0%"</span>,<span class="st">"0% to 2.5%"</span>,<span class="st">"2.5% to 5%"</span>,<span class="st">"5% to 10%"</span>,<span class="st">"10% to 20%"</span>,<span class="st">"20% to 30%"</span><span class="op">)</span>
<span class="va">colors</span> <span class="op">&lt;-</span> <span class="fu">RColorBrewer</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/RColorBrewer/man/ColorBrewer.html">brewer.pal</a></span><span class="op">(</span><span class="fl">10</span>,<span class="st">"PiYG"</span><span class="op">)</span>

<span class="va">compute_population_change_metrics</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">{</span>
 <span class="va">geometric_average</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>,<span class="va">n</span><span class="op">)</span><span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/sign.html">sign</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">1</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="va">n</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">}</span>
 <span class="va">data</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>`2001 - 2006`<span class="op">=</span><span class="fu">geometric_average</span><span class="op">(</span><span class="op">(</span><span class="va">`Population_2006`</span><span class="op">-</span><span class="va">`Population_2001`</span><span class="op">)</span><span class="op">/</span><span class="va">`Population_2001`</span>,<span class="fl">5</span><span class="op">)</span>,
         `2006 - 2011`<span class="op">=</span><span class="fu">geometric_average</span><span class="op">(</span><span class="op">(</span><span class="va">`Population_2011`</span><span class="op">-</span><span class="va">`Population_2006`</span><span class="op">)</span><span class="op">/</span><span class="va">`Population_2006`</span>,<span class="fl">5</span><span class="op">)</span>,
         `2011 - 2016`<span class="op">=</span><span class="fu">geometric_average</span><span class="op">(</span><span class="op">(</span><span class="va">`Population_2016`</span><span class="op">-</span><span class="va">`Population_2011`</span><span class="op">)</span><span class="op">/</span><span class="va">`Population_2011`</span>,<span class="fl">5</span><span class="op">)</span>,
         `2001 - 2016`<span class="op">=</span><span class="fu">geometric_average</span><span class="op">(</span><span class="op">(</span><span class="va">`Population_2016`</span><span class="op">-</span><span class="va">`Population_2001`</span><span class="op">)</span><span class="op">/</span><span class="va">`Population_2001`</span>,<span class="fl">15</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/gather.html">gather</a></span><span class="op">(</span>key<span class="op">=</span><span class="st">"Period"</span>,value<span class="op">=</span><span class="st">"Population Change"</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2001 - 2006"</span>,<span class="st">"2006 - 2011"</span>,<span class="st">"2011 - 2016"</span>,<span class="st">"2001 - 2016"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>Period<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">Period</span>,levels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2001 - 2006"</span>,<span class="st">"2006 - 2011"</span>,<span class="st">"2011 - 2016"</span>,<span class="st">"2001 - 2016"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
   <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>c<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/cut.html">cut</a></span><span class="op">(</span><span class="va">`Population Change`</span>,breaks<span class="op">=</span><span class="va">breaks</span>, labels<span class="op">=</span><span class="va">labels</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">plot_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tongfen_aggregate.html">tongfen_aggregate</a></span><span class="op">(</span><span class="va">data</span>,<span class="va">correspondence</span>,meta<span class="op">=</span><span class="va">meta</span>,base_geo <span class="op">=</span> <span class="st">"2001"</span><span class="op">)</span>  <span class="op">%&gt;%</span>
  <span class="fu">compute_population_change_metrics</span><span class="op">(</span><span class="op">)</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">plot_data</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill<span class="op">=</span><span class="va">c</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">0.1</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op">(</span>values<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="va">colors</span>,<span class="va">labels</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="st">"Period"</span>,ncol<span class="op">=</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">coord_sf</a></span><span class="op">(</span>datum<span class="op">=</span><span class="cn">NA</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>fill<span class="op">=</span><span class="st">"Average Annual\nPopulation Change"</span>,
       title<span class="op">=</span><span class="st">"Vancouver population change"</span>,
       caption <span class="op">=</span> <span class="st">"StatCan Census 2001-2016"</span><span class="op">)</span></code></pre></div>
<p><img src="tongfen_files/figure-html/unnamed-chunk-10-1.png" width="700"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://mountainmath.ca">Jens von Bergmann</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
